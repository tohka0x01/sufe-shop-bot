# Task 4: JWT认证升级

## Meta Information

- **Size**: M
- **Hours**: 6
- **depends_on**: []
- **parallel**: true
- **conflicts_with**: [8]
- **Status**: pending

## Objective

将当前的简单token认证系统升级为JWT（JSON Web Token）认证，提高安全性和可扩展性，同时保持向后兼容性。

## Detailed Description

### Scope
1. 设计JWT token结构和claims
2. 实现JWT生成和验证逻辑
3. 更新认证中间件支持JWT
4. 实现token刷新机制
5. 保持与现有token的向后兼容
6. 更新所有相关的API端点

### Technical Requirements
- 使用标准JWT库（如golang-jwt）
- 实现RS256或HS256签名算法
- Token过期时间可配置
- 支持token黑名单机制
- 实现refresh token功能

## Success Criteria

- [ ] JWT认证系统完全实现并测试通过
- [ ] 现有用户可以无缝迁移到JWT
- [ ] Token安全性得到提升
- [ ] API响应时间增加不超过10ms
- [ ] 完整的JWT管理功能（撤销、刷新等）

## Implementation Notes

### JWT Token结构
```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "sub": "user_id",
    "iat": 1234567890,
    "exp": 1234567890,
    "roles": ["admin", "user"],
    "custom": {
      "telegram_id": "123456",
      "username": "user"
    }
  }
}
```

### 迁移策略
1. **双轨运行期**
   - 同时支持旧token和JWT
   - 新登录发放JWT
   - 旧token继续有效直到过期

2. **Token识别**
   - JWT格式: `eyJhbGciOiJIUzI1NiIs...`
   - 旧token格式: `simple_token_format`

3. **数据迁移**
   - 保留现有token表
   - 新增JWT相关字段
   - 逐步迁移用户到JWT

### 实现步骤
1. 添加JWT依赖和配置
2. 实现JWT服务层
3. 更新认证中间件
4. 实现token刷新端点
5. 更新登录流程
6. 实现token管理功能

### API变更
```yaml
# 登录响应
POST /api/login
Response:
{
  "access_token": "eyJhbGciOiJIUzI1NiIs...",
  "refresh_token": "eyJhbGciOiJIUzI1NiIs...",
  "token_type": "Bearer",
  "expires_in": 3600
}

# 刷新Token
POST /api/token/refresh
Request:
{
  "refresh_token": "eyJhbGciOiJIUzI1NiIs..."
}

# 撤销Token
POST /api/token/revoke
Request:
{
  "token": "eyJhbGciOiJIUzI1NiIs..."
}
```

## Testing Requirements

- [ ] 单元测试：JWT生成和验证
- [ ] 集成测试：认证流程测试
- [ ] 安全测试：token篡改和过期测试
- [ ] 性能测试：JWT处理性能
- [ ] 兼容性测试：新旧token共存

## Risk Assessment

- **风险**: JWT无法撤销（无状态）
- **缓解**: 实现token黑名单机制
- **风险**: JWT体积较大
- **缓解**: 优化payload内容，使用短期token
- **风险**: 密钥泄露风险
- **缓解**: 使用环境变量存储，定期轮换密钥

## Dependencies

- JWT库选择和集成
- Redis（用于token黑名单）
- 密钥管理方案

## Notes

- 考虑实现多设备登录管理
- 预留权限系统扩展接口
- 实现JWT调试工具，方便开发测试
- 考虑实现单点登录（SSO）支持
- 注意JWT大小对API性能的影响